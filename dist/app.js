'use strict';var _typeof=typeof Symbol==='function'&&typeof Symbol.iterator==='symbol'?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==='function'&&obj.constructor===Symbol&&obj!==Symbol.prototype?'symbol':typeof obj};var _config=require('./config');var _config2=_interopRequireDefault(_config);var _bot=require('./lib/bot');var _bot2=_interopRequireDefault(_bot);var _store=require('./lib/store');var _store2=_interopRequireDefault(_store);var _express=require('express');var _express2=_interopRequireDefault(_express);var _dotenv=require('dotenv');var _dotenv2=_interopRequireDefault(_dotenv);var _nodeSchedule=require('node-schedule');var _nodeSchedule2=_interopRequireDefault(_nodeSchedule);var _lodash=require('lodash');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}if(process.env.NODE_ENV!=='production')_dotenv2.default.config({silent:process.env.NODE_ENV==='production'});var store=new _store2.default;var slackbot=new _bot2.default(_config2.default);var AVAILABILITY=['breakfast','lunch','dinner'];var app=(0,_express2.default)();app.set('port',process.env.PORT||5000);app.get('/',function(req,res){res.send('Nothing to see here')});app.listen(app.get('port'),function(){console.log('Express listening to port',app.get('port'))});//Listens for keywords
slackbot.controller.hears(['suggest (.*)','suggest'],['direct_message','direct_mention','mention'],function(bot,message){var mealType=_typeof(message.match[1]==='undefined')?message.match[1]:message.match[1].toLowerCase();var restriction=AVAILABILITY.indexOf(mealType)<0?'all':mealType;var suggestion=store.getRandomLunchVenue(restriction);var emoji=_config2.default.slack.emoji[Math.floor(Math.random()*(_config2.default.slack.emoji.length-1))];bot.reply(message,'Let\'s go to '+emoji+' *'+suggestion.title+'* !')});slackbot.controller.hears(['list (.*)','list','list all'],['direct_message','direct_mention','mention'],function(bot,message){var mealType=_typeof(message.match[1]==='undefined')?message.match[1]:message.match[1].toLowerCase();var restriction=AVAILABILITY.indexOf(mealType)<0?'all':mealType;var list=store.getVenueList(restriction);var txt='';var index=0;(0,_lodash.forEach)(list,function(v,k){return txt+=++index+'. '+v.title+' \n'});bot.reply(message,'Here you are:\n\n '+txt+' \n')});slackbot.controller.hears(['help','intro'],['direct_message','direct_mention','mention'],function(bot,message){var user=new Promise(function(resolve,reject){return slackbot.getUserInfo(bot,message,resolve)});var channel=new Promise(function(resolve,reject){return slackbot.getChannelInfo(bot,message,resolve)});Promise.all([user,channel]).then(function(val){var name=val[0].name;var channelname=val[1].name;var txt='Hi @'+name+' :wave:\n\n Welcome to the #'+channelname+' channel. You can ask me for a lunch (breakfast or dinner) suggestion. \n Here are some commands you can start with: \n ```@'+_config2.default.slack.username+' suggest\n@'+_config2.default.slack.username+' suggest dinner\n@'+_config2.default.slack.username+' list ```\n\n Also at '+_config2.default.scheduler.text+', I will suggest a random venue for lunch. \n\n';bot.reply(message,txt)})});//Listens for RTM events
slackbot.controller.on('user_channel_join',function(bot,message){var user=new Promise(function(resolve,reject){return slackbot.getUserInfo(bot,message,resolve)});var channel=new Promise(function(resolve,reject){return slackbot.getChannelInfo(bot,message,resolve)});Promise.all([user,channel]).then(function(val){var name=val[0].name;var channelname=val[1].name;if(_config2.default.slack.channel.indexOf(channelname)>=0){var txt='Hi @'+name+' :wave:\n\nWelcome to the '+_config2.default.slack.channel+' channel! Type `@'+_config2.default.slack.username+' help` for info.';bot.reply(message,txt)}})});//Making non meal related conversations
slackbot.controller.hears('',['direct_message','direct_mention','mention'],function(bot,message){var msg=message.text;if(msg.length){slackbot.cleverBotResponse(bot,message)}});//Schedule
var announcement=_nodeSchedule2.default.scheduleJob(_config2.default.scheduler.schedule,function(){var suggestion=store.getRandomLunchVenue('all');var emoji=_config2.default.slack.emoji[Math.floor(Math.random()*(_config2.default.slack.emoji.length-1))];var txt='Lunch time, peeps. Let\'s go to '+emoji+' *'+suggestion.title+'* ! :smile:';slackbot.sendIncomingWebhook(txt)});